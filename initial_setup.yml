---
- hosts: all
  # remote_user: pi
  tasks:
    - name: Set authorized key taken from file
      authorized_key:
        user: pi
        state: present
        key: "{{ lookup('file', '~/.ssh/id_rsa.pub') }}"

    - name: Run the equivalent of "apt-get update" as a separate step
      apt:
        update_cache: yes
      become: yes

    - name: Upgrade all packages to the latest version
      apt:
        name: "*"
        state: latest
      become: yes

    - name: Install necessary packages
      apt:
        pkg:
        - python-apt

    - name: Check CPU temp
      command: /opt/vc/bin/vcgencmd measure_temp
      register: cpu_temp
      become: yes

    - name: Enable IPv4 forwarding
      sysctl:
        name: net.ipv4.ip_forward
        value: "1"
        state: present
        reload: yes
      become: yes

    - name: Enable IPv6 forwarding
      sysctl:
        name: net.ipv6.conf.all.forwarding
        value: "1"
        state: present
        reload: yes
      become: yes

    - name: print CPU Temp
      debug: 
        msg: "{{cpu_temp.stdout}}"

    # - name: print facts
    #   debug:
    #     msg: "{{ansible_facts.userspace_bits}}"

    - name: Delete k3s if already present
      file:
        path: /usr/local/bin/k3s
        state: absent
      become: yes

    - name: Download k3s binary arm64
      get_url:
        url: https://github.com/rancher/k3s/releases/download/v1.18.8%2Bk3s1/k3s-armhf
        dest: /usr/local/bin/k3s
        owner: root
        group: root
        mode: 0755
      become: yes
      

    - name: Activating cgroup support
      lineinfile:
        path: /boot/cmdline.txt
        regexp: '^((?!.*\bcgroup_enable=cpuset cgroup_memory=1 cgroup_enable=memory\b).*)$'
        line: '\1 cgroup_enable=cpuset cgroup_memory=1 cgroup_enable=memory'
        backrefs: true
      notify: reboot
      become: yes
      # when:
      #   - raspbian is true

    - name: Flush iptables before changing to iptables-legacy
      iptables:
        flush: true
      # when: raspbian
      changed_when: false   # iptables flush always returns changed
      become: yes

    - name: Changing to iptables-legacy
      alternatives:
        path: /usr/sbin/iptables-legacy
        name: iptables
      register: ip4_legacy
      become: yes
      # when: raspbian

    - name: Changing to ip6tables-legacy
      alternatives:
        path: /usr/sbin/ip6tables-legacy
        name: ip6tables
      register: ip6_legacy
      become: yes
      # when: raspbian



  handlers:
    - name: reboot
      reboot:
      become: yes



